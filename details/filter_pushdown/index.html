<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Filter / Predicate Pushdown - Spark Advanced Topics</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../..">Spark Advanced Topics</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="../..">Spark Advanced Topics Working Group Documentation</a>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Details <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../analysis-exception/">org.apache.spark.sql.AnalysisException</a>
</li>
<li>
<a class="dropdown-item" href="../bad_partitioning/">Bad Partitioning</a>
</li>
<li>
<a class="dropdown-item" href="../big-broadcast-join/">Too big broadcast joins</a>
</li>
<li>
<a class="dropdown-item" href="../broadcast-with-disable/">Tables getting broadcasted even when broadcast is disabled</a>
</li>
<li>
<a class="dropdown-item" href="../class-or-method-not-found/">Class or method not found</a>
</li>
<li>
<a class="dropdown-item" href="../collect/">Bringing too much data back to the driver (collect and friends)</a>
</li>
<li>
<a class="dropdown-item" href="../container-oom/">Container OOMs</a>
</li>
<li>
<a class="dropdown-item" href="../correlated-column-not-allowed/">org.apache.spark.sql.AnalysisException: Correlated column is not allowed in predicate</a>
</li>
<li>
<a class="dropdown-item" href="../driver-max-result-size/">Result size larger than spark.driver.maxResultsSize error</a>
</li>
<li>
<a class="dropdown-item" href="../even_partioning_still_slow/">Even Partitioning Yet Still Slow</a>
</li>
<li>
<a class="dropdown-item" href="../executor-out-of-disk/">Executor out of disk error</a>
</li>
<li>
<a class="dropdown-item" href="../failed-to-read-non-parquet-file/">Failed to read non-parquet file</a>
</li>
<li>
<a class="dropdown-item" href="../failure-executor-large-record/">Failure executor large record</a>
</li>
<li>
<a class="dropdown-item" href="../failure-executor-out-of-memory/">Failure executor out of memory</a>
</li>
<li>
<a class="dropdown-item active" href="./">Filter / Predicate Pushdown</a>
</li>
<li>
<a class="dropdown-item" href="../forced-computations/">Force computations</a>
</li>
<li>
<a class="dropdown-item" href="../invalid-file/">Missing Files / File Not Found / Reading past RLE/BitPacking stream</a>
</li>
<li>
<a class="dropdown-item" href="../key-skew/">Key/Partition Skew</a>
</li>
<li>
<a class="dropdown-item" href="../partial_aggregates/">Partial v.s. Full Aggregates</a>
</li>
<li>
<a class="dropdown-item" href="../pyudfoom/">PySpark UDF / UDAF OOM</a>
</li>
<li>
<a class="dropdown-item" href="../regex-tips/">Regular Expression Tips</a>
</li>
<li>
<a class="dropdown-item" href="../slow-executor/">Slow executor</a>
</li>
<li>
<a class="dropdown-item" href="../toobigdag/">Too Big DAG (or when iterative algorithms go bump in the night)</a>
</li>
<li>
<a class="dropdown-item" href="../udfslow/">Avoid UDFs for the most part</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Flowchart <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../flowchart/">Index</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/error/">Error</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/shared/">Shared</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/slow/">Slow</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" data-target="#mkdocs_search_modal" data-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../failure-executor-out-of-memory/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../forced-computations/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#filter-predicate-pushdown">Filter / Predicate Pushdown</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="filter-predicate-pushdown">Filter / Predicate Pushdown</h1>
<p>Processing more data than necessary will typically slow down the job. 
If the input table is partitioned then applying filters on the partition columns can restrict the input volume Spark
 needs
 to scan.</p>
<p>A simple equality filter gets pushed down to the batch scan and enables Spark to only scan the files 
where <code>dateint = 20211101</code> of a sample table partitioned on <code>dateint</code> and <code>hour</code>.</p>
<p><div class="highlight"><pre><span></span><code>select *
from jlantos.sample_table
where dateint = 20211101
limit 100
</code></pre></div>
<img alt="Successful-Filter_Pushdown" src="../../imgs/spark-filter-pushdown-success.png"/></p>
<h3 id="examples-when-the-filter-does-not-get-pused-down">Examples when the filter does not get pused down</h3>
<h4 id="the-filter-contains-an-expression">The filter contains an expression</h4>
<p>If instead of a particular date we'd like to load data from the 1st of any month we might
 rewrite the above query such as:</p>
<div class="highlight"><pre><span></span><code>select *
from jlantos.sample_table
where dateint % 100 = 1
limit 100
</code></pre></div>
<p>The query plan shows that Spark in this case scans the whole table and filters only in a later step.</p>
<p><img alt="Successful-Filter_Pushdown" src="../../imgs/spark-filter-ignored.png"/></p>
<h3 id="filter-is-dynamic-via-a-join">Filter is dynamic via a join</h3>
<p>In a more complex job we might restrict the data based on joining to another table. If the filtering criteria is not
 static it won't be pushed down to the scan. So in the example below the two table scans happen independently, and
  <code>min(dateint)</code> calculated in the CTE won't have an affect on the second scan.</p>
<div class="highlight"><pre><span></span><code>with dates as
  (select min(dateint) dateint
   from jlantos.sample_table)

select *
from jlantos.sample_table st
join dates d on st.dateint = d.dateint
</code></pre></div></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Copyright various authors 2021, CC-BY-SA 4.0</p>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../../js/base.js"></script>
<script defer="" src="../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
