<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>Key/Partition Skew - Spark Advanced Topics</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet"/>
<link href="../../css/font-awesome.min.css" rel="stylesheet"/>
<link href="../../css/base.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" rel="stylesheet"/>
<script defer="" src="../../js/jquery-1.10.2.min.js"></script>
<script defer="" src="../../js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="../..">Spark Advanced Topics</a>
<!-- Expander button -->
<button class="navbar-toggler" data-target="#navbar-collapse" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<!-- Expanded navigation -->
<div class="navbar-collapse collapse" id="navbar-collapse">
<!-- Main navigation -->
<ul class="nav navbar-nav">
<li class="navitem">
<a class="nav-link" href="../..">Spark Advanced Topics Working Group Documentation</a>
</li>
<li class="dropdown active">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Details <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../analysis-exception/">org.apache.spark.sql.AnalysisException</a>
</li>
<li>
<a class="dropdown-item" href="../bad_partitioning/">Bad Partitioning</a>
</li>
<li>
<a class="dropdown-item" href="../big-broadcast-join/">Too big broadcast joins</a>
</li>
<li>
<a class="dropdown-item" href="../broadcast-with-disable/">Tables getting broadcasted even when broadcast is disabled</a>
</li>
<li>
<a class="dropdown-item" href="../class-or-method-not-found/">Class or method not found</a>
</li>
<li>
<a class="dropdown-item" href="../collect/">Bringing too much data back to the driver (collect and friends)</a>
</li>
<li>
<a class="dropdown-item" href="../container-oom/">Container OOMs</a>
</li>
<li>
<a class="dropdown-item" href="../correlated-column-not-allowed/">org.apache.spark.sql.AnalysisException: Correlated column is not allowed in predicate</a>
</li>
<li>
<a class="dropdown-item" href="../driver-max-result-size/">Result size larger than spark.driver.maxResultsSize error</a>
</li>
<li>
<a class="dropdown-item" href="../even_partioning_still_slow/">Even Partitioning Yet Still Slow</a>
</li>
<li>
<a class="dropdown-item" href="../executor-out-of-disk/">Executor out of disk error</a>
</li>
<li>
<a class="dropdown-item" href="../failed-to-read-non-parquet-file/">Failed to read non-parquet file</a>
</li>
<li>
<a class="dropdown-item" href="../failure-executor-large-record/">Failure executor large record</a>
</li>
<li>
<a class="dropdown-item" href="../failure-executor-out-of-memory/">Failure executor out of memory</a>
</li>
<li>
<a class="dropdown-item" href="../filter_pushdown/">Filter / Predicate Pushdown</a>
</li>
<li>
<a class="dropdown-item" href="../forced-computations/">Force computations</a>
</li>
<li>
<a class="dropdown-item" href="../invalid-file/">Missing Files / File Not Found / Reading past RLE/BitPacking stream</a>
</li>
<li>
<a class="dropdown-item active" href="./">Key/Partition Skew</a>
</li>
<li>
<a class="dropdown-item" href="../partial_aggregates/">Partial v.s. Full Aggregates</a>
</li>
<li>
<a class="dropdown-item" href="../pyudfoom/">PySpark UDF / UDAF OOM</a>
</li>
<li>
<a class="dropdown-item" href="../regex-tips/">Regular Expression Tips</a>
</li>
<li>
<a class="dropdown-item" href="../slow-executor/">Slow executor</a>
</li>
<li>
<a class="dropdown-item" href="../toobigdag/">Too Big DAG (or when iterative algorithms go bump in the night)</a>
</li>
<li>
<a class="dropdown-item" href="../udfslow/">Avoid UDFs for the most part</a>
</li>
</ul>
</li>
<li class="dropdown">
<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Flowchart <b class="caret"></b></a>
<ul class="dropdown-menu">
<li>
<a class="dropdown-item" href="../../flowchart/">Index</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/error/">Error</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/shared/">Shared</a>
</li>
<li>
<a class="dropdown-item" href="../../flowchart/slow/">Slow</a>
</li>
</ul>
</li>
</ul>
<ul class="nav navbar-nav ml-auto">
<li class="nav-item">
<a class="nav-link" data-target="#mkdocs_search_modal" data-toggle="modal" href="#">
<i class="fa fa-search"></i> Search
                            </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../invalid-file/" rel="prev">
<i class="fa fa-arrow-left"></i> Previous
                                </a>
</li>
<li class="nav-item">
<a class="nav-link" href="../partial_aggregates/" rel="next">
                                    Next <i class="fa fa-arrow-right"></i>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class="container">
<div class="row">
<div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
<div class="navbar-header">
<button class="navbar-toggler collapsed" data-target="#toc-collapse" data-toggle="collapse" title="Table of Contents" type="button">
<span class="fa fa-angle-down"></span>
</button>
</div>
<div class="navbar-collapse collapse card bg-secondary" id="toc-collapse">
<ul class="nav flex-column">
<li class="nav-item" data-level="1"><a class="nav-link" href="#keypartition-skew">Key/Partition Skew</a>
<ul class="nav flex-column">
</ul>
</li>
</ul>
</div>
</div></div>
<div class="col-md-9" role="main">
<h1 id="keypartition-skew">Key/Partition Skew</h1>
<p>Key or partition skew is a frequent problem in Spark. Key skew can result in everything from slowly running jobs (with straglers), to failing jobs.</p>
<p>What is data skew?</p>
<ol>
<li>
<p>Usually caused during a transformation when the data in one partition ends up being a lot more than the others, bumping up memory could resolve an OOM error but does not solve the underlying problem</p>
</li>
<li>
<p>Processing partitions are unbalanced by a magnitude then the largest partition becomes the bottleneck</p>
</li>
</ol>
<p>How to identify skew</p>
<ol>
<li>If one task took much longer to complete than the other tasks, it's usually a sign of Skew. On the Spark UI under Summary Metrics for completed tasks if the Max duration is higher by a significant magnitude from the Median it usually represents Skew, e.g.:
<img alt="Key-Skew-Spark-UI" src="../../imgs/spark-skewed.png"/></li>
</ol>
<p>Things to consider</p>
<ol>
<li>Mitigating skew has a cost (e.g. repartition) hence its ignorable unless the duration or input size is significantly higher in magnitude severely impacting job time</li>
</ol>
<p>Mitigation strategies</p>
<ol>
<li>
<p>Increasing executor memory to prevent OOM exceptions -&gt; This a short-term solution if you want to unblock yourself but does not address the underlying issue. Sometimes this is not an option when you are already running at the max memory settings allowable. </p>
</li>
<li>
<p>Salting is a way to balance partitions by introducing a salt/dummy key for the skewed partitions. Here is a sample workbook and an example of salting in content performance show completion pipeline, where the whole salting operation is parametrized with a JOIN_BUCKETS variable which helps with maintenance of this job.
<img alt="Spark-Salted-UI" src="../../imgs/spark-salted.png"/></p>
</li>
<li>
<p>Isolate the data for the skewed key, broadcast it for processing (e.g. join) and then union back the results</p>
</li>
<li>
<p>Adaptive Query Execution is a new framework with Spark 3.0, it enables Spark to dynamically identify skew. Under the hood adaptive query execution splits (and replicates if needed) skewed (large) partitions. If you don’t want to wait for 3.0, you can build the solution into the code by using the Salting/Partitioning technique listed above.</p>
</li>
<li>
<p>Using approximate functions/ probabilistic data structure</p>
</li>
<li>
<p>Using approximate distinct counts (Hyperloglog, bloom filter) can help get around skew if absolute precision isn't important.</p>
</li>
</ol>
<p>Approximate data structures like Tdigest can help with quantile computations.
If you need exact quantiles, check out the example in <a href="https://amzn.to/3cmdRw9">High Performance Spark</a></p>
<p>Certain types of aggregations and windows can result in partitioning the data on a particular key.</p></div>
</div>
</div>
<footer class="col-md-12">
<hr/>
<p>Copyright various authors 2021, CC-BY-SA 4.0</p>
<p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
</footer>
<script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
<script defer="" src="../../js/base.js"></script>
<script defer="" src="../../search/main.js"></script>
<div aria-hidden="true" aria-labelledby="searchModalLabel" class="modal" id="mkdocs_search_modal" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="searchModalLabel">Search</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<p>From here you can search these documents. Enter your search terms below.</p>
<form>
<div class="form-group">
<input class="form-control" id="mkdocs-search-query" placeholder="Search..." title="Type search term here" type="search"/>
</div>
</form>
<div data-no-results-text="No results found" id="mkdocs-search-results"></div>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="keyboardModalLabel" class="modal" id="mkdocs_keyboard_modal" role="dialog" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
<button class="close" data-dismiss="modal" type="button"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
</div>
<div class="modal-body">
<table class="table">
<thead>
<tr>
<th style="width: 20%;">Keys</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="help shortcut"><kbd>?</kbd></td>
<td>Open this help</td>
</tr>
<tr>
<td class="next shortcut"><kbd>n</kbd></td>
<td>Next page</td>
</tr>
<tr>
<td class="prev shortcut"><kbd>p</kbd></td>
<td>Previous page</td>
</tr>
<tr>
<td class="search shortcut"><kbd>s</kbd></td>
<td>Search</td>
</tr>
</tbody>
</table>
</div>
<div class="modal-footer">
</div>
</div>
</div>
</div>
</body>
</html>
